#!/usr/bin/env bash

set -euo pipefail

shfmt -d -i 4 .
find . -type f -exec file --mime-type {} \; |
    grep 'text/x-shellscript' |
    cut -d: -f1 |
    xargs shellcheck

REPO_ROOT="$(git rev-parse --show-toplevel)"
REPO_NAME="$(basename "$REPO_ROOT")"

crate_types=(
    lib
    bin
)

for t in "${crate_types[@]}"; do
    CRATE_NAME="$REPO_NAME-$t"

    pushd "$(mktemp -d --suffix ".$CRATE_NAME")" || exit

    # Generate this particular configuration
    cargo-generate generate \
        --init \
        --path "$REPO_ROOT" \
        --name "$CRATE_NAME" \
        --define "short_description=$CRATE_NAME CI project" \
        --"$t"

    # Test the init script
    ./bin/init
    if [[ -n "$(git status --short)" ]]; then
        # Assert that there's no uncommitted changes
        exit 1
    fi

    # Ensure the flake isn't broken
    nix flake check

    # Run the actual tests
    direnv exec . ci

    popd || exit
done
