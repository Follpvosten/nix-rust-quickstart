#!/usr/bin/env bash

set -euo pipefail

cleanup() {
    if [[ "${status:-1}" -eq 0 ]]; then
        # Delete ourself
        rm "$(git rev-parse --show-toplevel)/bin/init"

        # Add the generated lockfile, remove `./bin/init`
        git add -A

        # Make a first commit
        git commit -m "initial commit"

        # Output very clear message that it worked
        echo "Success! Have fun with your new project!"
    else
        >&2 echo
        >&2 echo "Make sure you've read \`CONTRIBUTING.md\`:"
        >&2 echo
        >&2 echo "---"
        >&2 echo
        >&2 cat CONTRIBUTING.md
        >&2 echo
        >&2 echo "---"
        >&2 echo
        >&2 echo "After following its guidance, try running this script again."
    fi
}
trap 'status=$?; cleanup; exit $status' EXIT

if ! git rev-parse --is-inside-work-tree &> /dev/null; then
    git init
fi

# Make Nix recognize the files
git add -A

# Generate the lockfile
nix flake lock

# Allow our `.envrc`
direnv allow
