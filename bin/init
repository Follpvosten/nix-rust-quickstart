#!/usr/bin/env bash

set -euo pipefail

cleanup() {
    if [[ "${status:-1}" -eq 0 ]]; then
        # Delete ourself and the containing directory since there's nothing else
        # in it
        REPO_ROOT="$(git rev-parse --show-toplevel)"
        rm -r "${REPO_ROOT:?}/bin"

        # Add the generated lockfile, remove `./bin/init`
        git add -A

        # Make a first commit
        git commit -m "initial commit"

        # Output very clear message that it worked
        echo "Success! Have fun with your new project!"
    else
        echo >&2
        echo >&2 "Make sure you've read \`CONTRIBUTING.md\`:"
        echo >&2
        echo >&2 "---"
        echo >&2
        cat >&2 CONTRIBUTING.md
        echo >&2
        echo >&2 "---"
        echo >&2
        echo >&2 "After following its guidance, try running this script again."
    fi
}
trap 'status=$?; cleanup; exit $status' EXIT

if ! git rev-parse --is-inside-work-tree &>/dev/null; then
    git init
fi

# Make Nix recognize the files
git add -A

# Generate the nix lockfile
nix flake lock

# Generate the rust lockfile
nix develop --command cargo generate-lockfile

# Allow our `.envrc`
direnv allow
